#!/usr/bin/env bash

if [[ $# -eq 1 ]]; then
    selected=$1
else
    # Get current tmux session names
    existing_sessions=$(tmux list-sessions -F "#S" 2>/dev/null)

    # Collect directories, filter out ones that match existing session names
    directories=$(
        while read -r base_dir; do
            [[ -d "$base_dir" ]] || continue
            find "$base_dir" -mindepth 1 -maxdepth 1 -type d 2>/dev/null
        done < ~/.tmux/sessionizer-directories.txt \
        | while read -r dir; do
            name=$(basename "$dir" | tr . _)
            if ! grep -qx "$name" <<< "$existing_sessions"; then
                echo "$dir"
            fi
        done
    )

    # Combine everything (fzf shows these in reverse order)
    selected=$(
        (
            echo "$existing_sessions"
            echo "$directories"
        ) | fzf
    )
fi

if [[ -z $selected ]]; then
    exit 0
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected
    exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds "$selected_name" -c "$selected" -n vim
    tmux send-keys -t "$selected_name:vim" "vim ." Enter
    tmux new-window -dt "$selected_name" -c "$selected" -n shell
fi

tmux switch-client -t $selected_name
